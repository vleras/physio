(()=>{var t={573:t=>{(()=>{"use strict";var e,a={};e=a,Object.defineProperty(e,"__esModule",{value:!0}),e.SHOPIFY_THEME_APP_EXTENSION_ID=e.SHOPIFY_CLIENT_ID=e.DEVELOPMENT_PATH_PREFIX=e.GEOSERVICE_URL=e.APP_URL=e.NODE_ENV=void 0,e.NODE_ENV="production",e.APP_URL="https://skosm.klarna.com",e.GEOSERVICE_URL=`${e.APP_URL}/geolocation/v1`,e.DEVELOPMENT_PATH_PREFIX="",e.SHOPIFY_CLIENT_ID="4439684aa13a71f0befb66b3a308e7d4",e.SHOPIFY_THEME_APP_EXTENSION_ID="b95936a9-74b6-4a95-8103-6a1b6459c25e",t.exports=a})()}},e={};function a(r){var n=e[r];if(void 0!==n)return n.exports;var i=e[r]={exports:{}};return t[r](i,i.exports,a),i.exports}(()=>{"use strict";const t=(...t)=>{console.log("[klarna-osm]",...t)},e=t=>new Promise((e=>setTimeout(e,t))),r=()=>{if(!(document.currentScript instanceof HTMLScriptElement))return"unknown";const t=document.currentScript.src.split("/").at(-3);return`${"0.0.0"===t?"local:":""}${t}`||"unknown"},n=()=>Array.from(document.getElementsByTagName("klarna-placement"));var i=a(573);class o{constructor(){this.store=null}async getStore(){return this.store||this.fetchStore()}async fetchStore(){const t=o.constructUrl(),e=await fetch(t.toString(),{headers:{"x-app-blocks-version":r()}});return this.store=await e.json(),this.store}static constructUrl(){var t;const e=window.location.hostname,a=null===(t=window.Shopify)||void 0===t?void 0:t.shop,r=e!==a?e:"",n=new URL(`${i.DEVELOPMENT_PATH_PREFIX}/app-blocks/v1/store`,i.APP_URL);return n.searchParams.set("defaultDomain",a),n.searchParams.set("customDomain",r),n}}async function s(){var t;const e=await fetch("/cart.json");if(!e.ok)throw new Error;return null!==(t=(await e.json()).total_price)&&void 0!==t?t:0}const c={"Europe/Vienna":"AT","Australia/Lord_Howe":"AU","Antarctica/Macquarie":"AU","Australia/Hobart":"AU","Australia/Currie":"AU","Australia/Melbourne":"AU","Australia/Sydney":"AU","Australia/Broken_Hill":"AU","Australia/Brisbane":"AU","Australia/Lindeman":"AU","Australia/Adelaide":"AU","Australia/Darwin":"AU","Australia/Perth":"AU","Australia/Eucla":"AU","Europe/Brussels":"BE","America/St_Johns":"CA","America/Halifax":"CA","America/Glace_Bay":"CA","America/Moncton":"CA","America/Goose_Bay":"CA","America/Blanc-Sablon":"CA","America/Toronto":"CA","America/Nipigon":"CA","America/Thunder_Bay":"CA","America/Iqaluit":"CA","America/Pangnirtung":"CA","America/Resolute":"CA","America/Atikokan":"CA","America/Rankin_Inlet":"CA","America/Winnipeg":"CA","America/Rainy_River":"CA","America/Regina":"CA","America/Swift_Current":"CA","America/Edmonton":"CA","America/Cambridge_Bay":"CA","America/Yellowknife":"CA","America/Inuvik":"CA","America/Creston":"CA","America/Dawson_Creek":"CA","America/Vancouver":"CA","America/Whitehorse":"CA","America/Dawson":"CA","Europe/Zurich":"CH","Europe/Prague":"CZ","Europe/Berlin":"DE","Europe/Busingen":"DE","Europe/Copenhagen":"DK","Europe/Madrid":"ES","Africa/Ceuta":"ES","Atlantic/Canary":"ES","Europe/Helsinki":"FI","Europe/Paris":"FR","Europe/Budapest":"HU","Europe/Rome":"IT","America/Mexico_City":"MX","America/Cancun":"MX","America/Merida":"MX","America/Monterrey":"MX","America/Matamoros":"MX","America/Mazatlan":"MX","America/Chihuahua":"MX","America/Ojinaga":"MX","America/Hermosillo":"MX","America/Tijuana":"MX","America/Santa_Isabel":"MX","America/Bahia_Banderas":"MX","Europe/Amsterdam":"NL","Arctic/Longyearbyen":"NO","Europe/Oslo":"NO","Europe/Warsaw":"PL","Europe/Lisbon":"PT","Atlantic/Madeira":"PT","Atlantic/Azores":"PT","Europe/Stockholm":"SE","Europe/Bratislava":"SK"},l="klarnaosm_user_locale";class u{static getCountryFromTimeZone(){var e;const{timeZone:a}=Intl.DateTimeFormat().resolvedOptions(),r=null!==(e=c[a])&&void 0!==e?e:null;return r||t("[getCountryFromTimeZone] unsupported country or time zone",{timeZone:a}),r}static async fetchUserCountry(){let e=u.getCachedUsersCountry();if(e)return t("Found users country in cache"),e;try{const t=new AbortController;setTimeout((()=>t.abort()),1500);const a=window.location.hostname,n=Shopify.shop,o=a!==n?a:"",s=new URL(i.GEOSERVICE_URL);s.searchParams.set("defaultDomain",n),s.searchParams.set("customDomain",o);const c=await fetch(s,{signal:t.signal,headers:{"x-app-blocks-version":r()}});if(!c.ok)throw new Error(c.statusText);e=(await c.json()).country}catch(e){return t("[getUsersCountry] Failed",e),t("[getUsersCountry] trying to parse from time zone"),this.getCountryFromTimeZone()}return e&&u.setCachedUsersCountry(e),e}static getCachedUsersCountry(){return localStorage.getItem(l)||null}static setCachedUsersCountry(e){t("Setting users country to cache",e),localStorage.setItem(l,e)}constructor(t){this.midLocales=null!=t?t:{}}static findLocale(e,a,r){var n,i;if(e){t("[getMatchingLocale] Valid locales for users country",e);const o=null!==(n=e[0])&&void 0!==n?n:null;let s="";if(a&&"undefined"!=typeof Shopify?(s=Shopify.locale,t("[getMatchingLocale] Using Shopify.locale",s)):navigator.language&&(s=navigator.language.slice(0,2),t("[getMatchingLocale] Using browser language",s)),s){const t=e.find((t=>t.startsWith(s)));if(t)return t}return r&&null!==(i=e.find((t=>t.startsWith("en"))))&&void 0!==i?i:o}return null}getMatchingLocale(e,a,r){if(!e||!this.midLocales)return t("[getMatchingLocale] Invalid data",e,this.midLocales),null;t("[getMatchingLocale] Available countries for merchant",r);const n=this.getFilteredLocales(r);t("[getMatchingLocale] Valid locales for merchant",n);const i=null==n?void 0:n[e];return u.findLocale(i,a,!0)}getFilteredLocales(t){if(!t)return this.midLocales;const e=new Set(t);return Object.keys(this.midLocales).reduce(((t,a)=>{var r;return e.has(a)&&(t[a]=null!==(r=this.midLocales[a])&&void 0!==r?r:[]),t}),{})}getMatchingLocaleWithMidLocales(e,a){var r;if(!e||!this.midLocales||0===Object.keys(this.midLocales).length)return t("[getMatchingLocale] Invalid data",e,this.midLocales),null;const n=this.getMidLocales(e);if(!n)return t(`[getMatchingLocale] Country ${e} not in MID Locales`),null;t("[getMatchingLocale] Available languages for merchant",n);const i=null!==(r=n[0])&&void 0!==r?r:null,o=n.find((t=>t.startsWith(a)));if(o)return t("[getMatchingLocale] Found matching locale",o),o;const s=n.find((t=>t.startsWith("en")));return s?(t("[getMatchingLocale] Found matching locale (defaulted to English)",s),s):i}getMidLocales(t){return"NO"===t&&this.midLocales[t]&&this.midLocales[t].includes("no-NO")&&!this.midLocales[t].includes("nb-NO")&&this.midLocales[t].push("nb-NO"),this.midLocales[t]}}const d=u;class h{constructor(t){this.store=t}inject(){if(!this.isOSMScriptAlreadyInjected())try{this.injectKlarnaOSMScriptTag(),t("Klarna OSM Script Tag has been added successfully")}catch(e){t("Could not add script element",e)}}isOSMScriptAlreadyInjected(){return null!==document.getElementById("klarna-osm-script-tag")}logIfEmptyClientId(){this.store.client_id||t("Creating OSM script element without data-client-id. This will cause placements not to show up. Check your configuration of Klarna OSM on the Klarna Merchant Portal.")}injectKlarnaOSMScriptTag(){const t=this.createKlarnaOSMScriptTag(),e=document.querySelector("body");e.insertBefore(t,e.children[0])}createKlarnaOSMScriptTag(){this.logIfEmptyClientId();const t=document.createElement("script"),e=this.store.playground_active?"playground":"production";return t.id="klarna-osm-script-tag",t.async=!0,t.setAttribute("data-environment",e),t.src="https://js.klarna.com/web-sdk/v1/klarna.js",t.setAttribute("data-client-id",this.store.client_id),t}}class m{static getVariantIdFromQueryString(){const t=new URLSearchParams(window.location.search).get("variant");return t?Number.parseInt(t,10):null}constructor(t,e){this.store=t,this.productVariants=e,this.localeService=new d(t.mid_locales)}async init(){var t;window.klarna_OSMP=window.klarna_OSMP||{},window.klarna_OSMP.updaterId=null!==(t=window.klarna_OSMP.updaterId)&&void 0!==t?t:0,this.injectOnSiteScript(),await this.initPurchaseAmountIfCartOrProductPage(),this.listenForInputChange()}injectOnSiteScript(){new h(this.store).inject()}async initPurchaseAmountIfCartOrProductPage(){["cart","product"].includes(this.currentPageType)&&await this.updatePurchaseAmount()}listenForInputChange(){"cart"===this.currentPageType&&this.updatePlacementsOnDomMutations(),"product"===this.currentPageType&&new MutationObserver((e=>{n().forEach((e=>{const a=String(this.getDataPurchaseAmount()||0),r=e.getAttribute("data-purchase-amount");a!==e.getAttribute("data-purchase-amount")&&(t(`amount changed from ${r} to ${a}`),e.setAttribute("data-purchase-amount",a))}))})).observe(document.body,{childList:!0,subtree:!0})}updatePlacementsOnDomMutations(){new MutationObserver(function(t){let e=!1;return function(){e||(e=!0,t(),setTimeout((()=>{e=!1}),1e3))}}((async()=>{window.klarna_OSMP.updaterId+=1;const t=window.klarna_OSMP.updaterId,a=[void 0,void 0,await s()];let r=5;const n=async()=>{const t=await s();return!!a.some((e=>e!==t))&&(await this.updatePurchaseAmount(t),a.shift(),a.push(t),!0)};for(;r>0&&t===window.klarna_OSMP.updaterId;)r-=1,await e(1e3),await n()}))).observe(document.body,{childList:!0,subtree:!0})}async updatePurchaseAmount(e=""){const a=n();let r=e;r||("cart"===this.currentPageType?r=await s():"product"===this.currentPageType&&(r=this.getDataPurchaseAmount())),t("Updating placements with new amount",{placements:a,purchaseAmount:r}),a.forEach((t=>{t.setAttribute("data-purchase-amount",String(r))}))}}const p=["credit-promotion-auto-size","credit-promotion-badge"];class g extends m{constructor(t,e){super(t,e.productVariants),this.data=e,this.currentPageType=e.templateName}async init(){var e;const a=this.getKlarnaPlacement(),r=this.getLocale();if(null===r||this.isDynamicPlacement()&&!this.hasMatchingCurrency())return t(`Removing placement ${a.id} `),void a.remove();a.setAttribute("data-locale",r),a.setAttribute("data-purchase-amount",this.getPurchaseAmount()),"product"===this.currentPageType&&"0"===this.getPurchaseAmount()&&this.isDynamicPlacement()&&(t("[AppBlocksInject] using fallback placement",this.store.fallback_placement),a.setAttribute("data-key",this.store.fallback_placement)),a.setAttribute("data-preloaded","true"),a.setAttribute("data-integration-style","app-blocks");const n=Number.isNaN(this.data.topPadding)?0:this.data.topPadding,i=Number.isNaN(this.data.bottomPadding)?0:this.data.bottomPadding;(+n>0||+i>0)&&(null===(e=document.getElementById(`shopify-block-${this.data.selector.slice(12)}`))||void 0===e||e.setAttribute("style",`padding: ${n}px 0px ${i}px 0px;`)),await super.init()}getPurchaseAmount(){var t;return"product"===this.currentPageType?this.data.variantPrice:"cart"===this.currentPageType?this.data.cartPrice:(null===(t=window.Shopify)||void 0===t?void 0:t.designMode)?"10998":"0"}hasMatchingCurrency(){const e=this.data.storefrontCurrency,a=g.localeToCurrency(this.data.storefrontCountry);return a?e===a||(t(`Currency mismatch. Storefront currency (${e}) is not the same as Klarna placement currency (${a})`,{storefrontCountry:this.data.storefrontCountry,displayedCurrency:e,localeCurrency:a}),!1):(t(`Currency for country ${a} not found.`,{storefrontCountry:this.data.storefrontCountry,displayedCurrency:e,localeCurrency:a}),!1)}isDynamicPlacement(){var t;return null!==(t=p.includes(this.data.dataKey))&&void 0!==t&&t}getLocale(){const[e,a]=[this.data.storefrontCountry,this.data.storefrontLanguage],r=this.localeService.getMatchingLocaleWithMidLocales(e,a);return r?t("Got matching locale",{storefrontCountry:e,matchingLocale:r,midLocales:this.store.mid_locales}):t("No matching locale found",{storefrontCountry:e,storefrontLanguage:a,midLocales:this.store.mid_locales}),r}getDataPurchaseAmount(){var t,e,a,r,n,i,o,s;let c=null;const l=m.getVariantIdFromQueryString();return l&&(c=null===(t=this.productVariants)||void 0===t?void 0:t.find((t=>t.id===l))),c?c.price:null!==(s=null!==(n=null===(r=null===(a=null===(e=this.productVariants)||void 0===e?void 0:e.filter((t=>t.available)))||void 0===a?void 0:a[0])||void 0===r?void 0:r.price)&&void 0!==n?n:null===(o=null===(i=this.productVariants)||void 0===i?void 0:i[0])||void 0===o?void 0:o.price)&&void 0!==s?s:0}getKlarnaPlacement(){const t=document.getElementById(this.data.selector);if(!t)throw new Error("Could not get klarna placement element");return t}static localeToCurrency(t){return{AU:"AUD",AT:"EUR",BE:"EUR",CA:"CAD",CZ:"CZK",DK:"DKK",FI:"EUR",FR:"EUR",DE:"EUR",GR:"EUR",HU:"HUF",IE:"EUR",IT:"EUR",MX:"MXN",NL:"EUR",NZ:"NZD",NO:"NOK",PL:"PLN",PT:"EUR",RO:"RON",SK:"EUR",ES:"EUR",SE:"SEK",CH:"CHF",GB:"GBP",US:"USD"}[t]||null}}t("app blocks loaded"),t("Version:",r());const A=window.appBlockPlacements||[];window.klarnaAppBlocksManager||(window.klarnaAppBlocksManager=new class{async pushPlacement(t){const e=await this.storeService.getStore();await new g(e,t).init()}constructor(t){this.placements=t,this.storeService=new o,this.push=this.pushPlacement.bind(this),this.placements.forEach(this.push)}}(A))})()})();